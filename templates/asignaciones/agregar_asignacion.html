{% extends 'base.html' %}

{% block title %}{{ title }} - Sistema de Inventario{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #1a237e;
        --primary-light: #3949ab;
        --primary-dark: #0d133d;
        --success: #43a047;
        --info: #1976d2;
        --warning: #fbc02d;
        --danger: #e53935;
        --gray-bg: #f4f6fa;
        --gray-light: #e3e6ef;
        --gray-dark: #374151;
        --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        --border-radius: 12px;
        --border-radius-lg: 16px;
    }
    body {
        background: var(--gray-bg);
    }
    .page-header-asignacion {
        background: var(--gradient-primary);
        color: white;
        padding: 2.5rem 0 2rem 0;
        border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        margin: -2rem -2rem 2rem -2rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
    }
    .page-header-asignacion .container {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    .page-title-asignacion {
        font-size: 2.3rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .page-title-asignacion i {
        font-size: 2.2rem;
        margin-right: 0.7rem;
        background: rgba(255,255,255,0.13);
        padding: 0.7rem;
        border-radius: var(--border-radius);
    }
    .page-subtitle-asignacion {
        font-size: 1.15rem;
        opacity: 0.92;
        margin-top: 0.5rem;
        margin-bottom: 0;
        font-weight: 400;
    }
    .page-header-asignacion .tips {
        margin-top: 1.2rem;
        background: rgba(255,255,255,0.08);
        border-radius: 10px;
        padding: 1rem 1.5rem;
        font-size: 1rem;
        color: #e3e6ef;
        font-style: italic;
        max-width: 600px;
    }
    .form-section {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 2rem 2.2rem 1.5rem 2.2rem;
        box-shadow: var(--shadow-soft);
        margin-bottom: 2rem;
        border-left: 5px solid var(--primary);
        position: relative;
        overflow: hidden;
        min-width: 0;
        transition: box-shadow 0.2s, transform 0.2s;
    }
    .form-section h5 {
        color: var(--primary-dark);
        font-weight: 700;
        margin-bottom: 1.2rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--gray-light);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .form-section .section-desc {
        color: var(--gray-dark);
        font-size: 0.98rem;
        margin-bottom: 1.2rem;
        opacity: 0.85;
    }
    .form-control, .form-select {
        border: 2px solid var(--gray-light);
        border-radius: 10px;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--success);
        box-shadow: 0 0 0 0.2rem rgba(67, 160, 71, 0.25);
    }

    .form-label {
        font-weight: 600;
        color: var(--gray-dark);
        margin-bottom: 0.5rem;
    }

    .required-field::after {
        content: ' *';
        color: var(--danger);
    }

    .btn-create {
        background: linear-gradient(135deg, var(--success) 0%, #66bb6a 100%);
        border: none;
        padding: 1rem 2.2rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(67, 160, 71, 0.13);
        font-size: 1.15rem;
        display: flex;
        align-items: center;
        gap: 0.7rem;
    }

    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
        background: linear-gradient(135deg, var(--success) 0%, var(--primary) 100%);
        color: white;
    }

    .btn-cancel {
        background: none;
        border: 2px solid var(--gray-light);
        padding: 1rem 2.2rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        color: var(--gray-dark);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(55, 65, 81, 0.13);
        font-size: 1.15rem;
        display: flex;
        align-items: center;
        gap: 0.7rem;
    }

    .btn-cancel:hover {
        background: var(--danger);
        border-color: var(--danger);
        color: white;
        transform: translateY(-2px);
    }

    .warning-box {
        background: linear-gradient(135deg, var(--warning) 0%, #ffeb3b 100%);
        color: var(--gray-dark);
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        font-size: 1.05rem;
        box-shadow: var(--shadow-soft);
        display: flex;
        align-items: center;
        gap: 0.7rem;
    }

    .product-preview {
        background: var(--gray-bg);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        border-left: 4px solid var(--success);
        display: none;
        margin-bottom: 1rem;
    }

    .product-preview.show {
        display: block;
    }

    .employee-info {
        background: var(--gray-bg);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-top: 0.5rem;
        display: none;
    }

    .employee-info.show {
        display: block;
    }

    .assignment-type-info {
        background: linear-gradient(135deg, var(--info) 0%, #42a5f5 100%);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-top: 1rem;
    }

    .side-summary {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-soft);
        padding: 1.5rem 1.2rem;
        margin-bottom: 2rem;
        border-left: 5px solid var(--info);
        min-height: 180px;
    }

    .side-summary h6 {
        color: var(--primary-dark);
        font-weight: 700;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .side-summary .summary-list {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 1rem;
    }

    .side-summary .summary-list li {
        margin-bottom: 0.7rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .side-summary .summary-list i {
        color: var(--primary-light);
        font-size: 1.1rem;
    }

    @media (max-width: 900px) {
        .form-section, .side-summary, .assignment-type-info, .warning-box {
            padding: 1rem;
        }
        .page-header-asignacion {
            padding: 1.2rem 0 1rem 0;
        }
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'asignaciones:lista_asignaciones' %}">Asignaciones</a></li>
        <li class="breadcrumb-item active">{{ title }}</li>
    </ol>
</nav>
{% endblock %}

<!-- HEADER UNIFICADO -->
<div class="page-header-asignacion">
    <div class="container">
        <h1 class="page-title-asignacion">
            <i class="fas fa-handshake"></i>
            {{ title }}
        </h1>
        <p class="page-subtitle-asignacion">Completa el formulario para asignar un producto a un empleado o departamento</p>
        <div class="tips">
            <i class="fas fa-lightbulb me-2"></i>
            Solo se pueden asignar productos en estado "Disponible". La asignación cambiará automáticamente el estado del producto.
        </div>
    </div>
</div>

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="fas fa-handshake me-2"></i>{{ title }}
    </h2>
    <a href="{% url 'asignaciones:lista_asignaciones' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Volver a la lista
    </a>
</div>

<div class="warning-box">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Importante:</strong> Solo se pueden asignar productos que estén en estado "Disponible".
    La asignación cambiará automáticamente el estado del producto.
</div>

<form method="post">
    {% csrf_token %}

    <div class="row">
        <div class="col-lg-8">
            <!-- Selección de producto -->
            <div class="form-section">
                <h5><i class="fas fa-box me-2"></i>Seleccionar Producto</h5>

                <div class="mb-3">
                    <label for="producto" class="form-label required-field">Producto</label>
                    <select name="producto" id="producto" class="form-select" required>
                        <option value="">Selecciona un producto...</option>
                        {% for producto in productos %}
                            <option value="{{ producto.id }}"
                                    data-nombre="{{ producto.marca.nombre }} {{ producto.modelo }}"
                                    data-marca="{{ producto.marca.nombre }}"
                                    data-modelo="{{ producto.modelo }}"
                                    data-categoria="{{ producto.categoria.nombre }}"
                                    data-ubicacion="{{ producto.ubicacion_actual.nombre|default:'Sin ubicación' }}"
                                    data-serie="{{ producto.numero_serie|default:'' }}"
                                    data-estado="{{ producto.estado }}"
                                    data-condicion="{{ producto.get_condicion_display }}">
                                {{ producto.marca.nombre }} {{ producto.modelo }} - {{ producto.categoria.nombre }} ({{ producto.numero_serie }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="product-preview" id="productPreview">
                    <h6><i class="fas fa-eye me-2"></i>Vista previa del producto</h6>
                    <div id="productDetails"></div>
                </div>
            </div>

            <!-- Información de asignación -->
            <div class="form-section">
                <h5><i class="fas fa-clipboard-list me-2"></i>Detalles de la Asignación</h5>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="departamento" class="form-label required-field">Departamento</label>
                            <select name="departamento" id="departamento" class="form-select" required>
                                <option value="">Selecciona un departamento...</option>
                                {% for departamento in departamentos %}
                                    <option value="{{ departamento.id }}">{{ departamento.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="empleado" class="form-label required-field">Empleado Receptor</label>
                            <select name="empleado" id="empleado" class="form-select" required>
                                <option value="">Selecciona un empleado...</option>
                                {% for empleado in empleados %}
                                    <option value="{{ empleado.id }}"
                                            data-email="{{ empleado.email|default:'' }}"
                                            data-telefono="{{ empleado.telefono|default:'' }}"
                                            data-departamento="{{ empleado.departamento.id|default:'' }}">
                                        {{ empleado.nombre }} - {{ empleado.departamento.nombre|default:'Sin departamento' }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="employee-info" id="employeeInfo">
                                <div id="employeeDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="tipo_asignacion" class="form-label required-field">Tipo de Asignación</label>
                            <select name="tipo_asignacion" id="tipo_asignacion" class="form-select" required>
                                <option value="">Selecciona el tipo...</option>
                                {% for value, label in tipos_asignacion %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="fecha_entrega" class="form-label required-field">Fecha de Entrega</label>
                            <input type="date" name="fecha_entrega" id="fecha_entrega" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="assignment-type-info" id="assignmentTypeInfo" style="display: none;">
                    <h6><i class="fas fa-info-circle me-2"></i>Información sobre el tipo de asignación</h6>
                    <p id="assignmentTypeDescription"></p>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Resumen -->
            <div class="side-summary">
                <h6><i class="fas fa-clipboard-check me-2"></i>Resumen de Asignación</h6>

                <div id="assignmentSummary">
                    <p class="text-muted text-center py-3">
                        <i class="fas fa-clipboard fa-2x mb-2 d-block"></i>
                        Complete los campos para ver el resumen
                    </p>
                </div>
            </div>

            <!-- Observaciones -->
            <div class="form-section">
                <h5><i class="fas fa-comment me-2"></i>Observaciones</h5>
                <textarea name="observaciones" class="form-control" rows="5"
                          placeholder="Observaciones adicionales sobre la asignación (opcional)"></textarea>
            </div>

            <!-- Botones de acción -->
            <div class="form-section">
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-create" id="submitBtn" disabled>
                        <i class="fas fa-handshake me-2"></i>Crear Asignación
                    </button>
                    <a href="{% url 'asignaciones:lista_asignaciones' %}" class="btn btn-cancel">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Establecer fecha actual por defecto
    document.getElementById('fecha_entrega').value = new Date().toISOString().split('T')[0];

    // Información sobre tipos de asignación
    const tiposInfo = {
        'ENTREGA': 'Entrega permanente del producto al empleado. El producto pasará a estado "Entregado".',
        'PRESTAMO': 'Préstamo temporal del producto. Se espera su devolución posterior.',
        'MANTENIMIENTO': 'Asignación para tareas de mantenimiento o reparación.'
    };

    // Mostrar información del producto seleccionado
    document.getElementById('producto').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const preview = document.getElementById('productPreview');

        if (this.value) {
            const details = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Nombre:</strong> ${option.dataset.nombre}<br>
                        <strong>Categoría:</strong> ${option.dataset.categoria}<br>
                        <strong>Marca:</strong> ${option.dataset.marca}
                    </div>
                    <div class="col-md-6">
                        <strong>Ubicación:</strong> ${option.dataset.ubicacion}<br>
                        ${option.dataset.serie ? `<strong>N° Serie:</strong> ${option.dataset.serie}<br>` : ''}
                        <span class="product-status">DISPONIBLE</span>
                    </div>
                </div>
            `;
            document.getElementById('productDetails').innerHTML = details;
            preview.classList.add('show');
        } else {
            preview.classList.remove('show');
        }
        updateSummary();
    });

    // Mostrar información del empleado seleccionado
    document.getElementById('empleado').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const info = document.getElementById('employeeInfo');

        if (this.value) {
            let details = `<strong>Empleado:</strong> ${option.text.split(' - ')[0]}`;
            if (option.dataset.email) {
                details += `<br><strong>Email:</strong> ${option.dataset.email}`;
            }
            if (option.dataset.telefono) {
                details += `<br><strong>Teléfono:</strong> ${option.dataset.telefono}`;
            }

            document.getElementById('employeeDetails').innerHTML = details;
            info.classList.add('show');

            // Auto-seleccionar departamento si coincide
            if (option.dataset.departamento) {
                document.getElementById('departamento').value = option.dataset.departamento;
            }
        } else {
            info.classList.remove('show');
        }
        updateSummary();
    });

    // Mostrar información del tipo de asignación
    document.getElementById('tipo_asignacion').addEventListener('change', function() {
        const infoDiv = document.getElementById('assignmentTypeInfo');
        const descDiv = document.getElementById('assignmentTypeDescription');

        if (this.value && tiposInfo[this.value]) {
            descDiv.textContent = tiposInfo[this.value];
            infoDiv.style.display = 'block';
        } else {
            infoDiv.style.display = 'none';
        }
        updateSummary();
    });

    // Actualizar departamento
    document.getElementById('departamento').addEventListener('change', updateSummary);
    document.getElementById('fecha_entrega').addEventListener('change', updateSummary);

    function updateSummary() {
        const producto = document.getElementById('producto');
        const departamento = document.getElementById('departamento');
        const empleado = document.getElementById('empleado');
        const tipo = document.getElementById('tipo_asignacion');
        const fecha = document.getElementById('fecha_entrega');
        const submitBtn = document.getElementById('submitBtn');
        const summaryDiv = document.getElementById('assignmentSummary');

        if (producto.value && departamento.value && empleado.value && tipo.value && fecha.value) {
            const productoText = producto.options[producto.selectedIndex].dataset.nombre;
            const departamentoText = departamento.options[departamento.selectedIndex].text;
            const empleadoText = empleado.options[empleado.selectedIndex].text.split(' - ')[0];
            const tipoText = tipo.options[tipo.selectedIndex].text;

            summaryDiv.innerHTML = `
                <div class="mb-3">
                    <h6><i class="fas fa-box me-2"></i>Producto</h6>
                    <p class="mb-2">${productoText}</p>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-user me-2"></i>Receptor</h6>
                    <p class="mb-2">${empleadoText}</p>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-building me-2"></i>Departamento</h6>
                    <p class="mb-2">${departamentoText}</p>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-tags me-2"></i>Tipo</h6>
                    <p class="mb-2">${tipoText}</p>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-calendar me-2"></i>Fecha</h6>
                    <p class="mb-2">${fecha.value}</p>
                </div>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <small>Listo para crear la asignación</small>
                </div>
            `;

            submitBtn.disabled = false;
        } else {
            summaryDiv.innerHTML = `
                <p class="text-muted text-center py-3">
                    <i class="fas fa-clipboard fa-2x mb-2 d-block"></i>
                    Complete los campos para ver el resumen
                </p>
            `;
            submitBtn.disabled = true;
        }
    }

    // Validar formulario antes de enviar
    document.querySelector('form').addEventListener('submit', function(e) {
        const required = ['producto', 'departamento', 'empleado', 'tipo_asignacion', 'fecha_entrega'];
        let valid = true;

        required.forEach(field => {
            const input = document.getElementById(field);
            if (!input.value) {
                valid = false;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (!valid) {
            e.preventDefault();
            alert('Por favor, complete todos los campos obligatorios.');
        }
    });
</script>
{% endblock %}
